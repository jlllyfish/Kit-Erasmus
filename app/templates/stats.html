{% extends "base.html" %}

{% block content %}
<!-- Menu déroulant établissements -->
<div class="filter-section">
    <select id="etabSelect" class="etab-select" onchange="changeEtablissement()">
        <option value="Tous" {% if selected_etab == 'Tous' %}selected{% endif %}>Tous les établissements</option>
        {% for etab in etablissements %}
        <option value="{{ etab }}" {% if etab == selected_etab %}selected{% endif %}>{{ etab }}</option>
        {% endfor %}
    </select>
</div>

<!-- Big Number -->
<div class="stats-big-number">
    <div class="big-number-card">
        <div class="big-number-value" id="totalMobilites">-</div>
        <div class="big-number-label">Mobilités</div>
    </div>
    <div class="big-number-card">
        <div class="big-number-value" id="totalJours">-</div>
        <div class="big-number-label">Jours consommés</div>
    </div>
    <div class="big-number-card">
        <div class="big-number-value" id="pctConsommation">-%</div>
        <div class="big-number-label">Consommation</div>
    </div>
</div>

<!-- Graphiques -->
<div class="charts-grid">
    <!-- Donut : Répartition par pays -->
    <div class="chart-card">
        <h3 class="chart-title">Répartition par pays</h3>
        <div id="chartDonut"></div>
    </div>
    
    <!-- Courbe : Évolution temporelle -->
    <div class="chart-card">
        <h3 class="chart-title">Mobilités par mois (depuis 2026)</h3>
        <div id="chartLine"></div>
    </div>
</div>

<!-- ApexCharts Library -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
let donutChart = null;
let lineChart = null;

function changeEtablissement() {
    const select = document.getElementById('etabSelect');
    const etab = select.value;
    window.location.href = `/statistiques?etab=${encodeURIComponent(etab)}`;
}

async function loadChartData() {
    const etab = document.getElementById('etabSelect').value;
    
    try {
        const response = await fetch(`/api/chart_data?etab=${encodeURIComponent(etab)}`);
        const data = await response.json();
        
        // Big Number
        document.getElementById('totalMobilites').textContent = data.total;
        document.getElementById('totalJours').textContent = data.total_jours;
        document.getElementById('pctConsommation').textContent = data.pct_consommation + '%';
        
        // Donut Chart
        if (donutChart) {
            donutChart.destroy();
        }
        
        const donutOptions = {
            series: data.donut.series,
            chart: {
                type: 'donut',
                height: 350,
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto'
            },
            labels: data.donut.labels,
            colors: ['#000000', '#404040', '#808080', '#c0c0c0', '#f0f0f0'],
            legend: {
                position: 'bottom',
                fontSize: '14px'
            },
            dataLabels: {
                enabled: true,
                style: {
                    fontSize: '12px',
                    fontWeight: 600
                }
            },
            plotOptions: {
                pie: {
                    donut: {
                        size: '65%',
                        labels: {
                            show: true,
                            name: {
                                fontSize: '16px',
                                fontWeight: 600
                            },
                            value: {
                                fontSize: '24px',
                                fontWeight: 700
                            }
                        }
                    }
                }
            }
        };
        
        donutChart = new ApexCharts(document.querySelector("#chartDonut"), donutOptions);
        donutChart.render();
        
        // Line Chart
        if (lineChart) {
            lineChart.destroy();
        }
        
        const lineOptions = {
            series: [{
                name: 'Mobilités',
                data: data.line.series
            }],
            chart: {
                type: 'line',
                height: 350,
                fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto',
                toolbar: {
                    show: false
                }
            },
            stroke: {
                curve: 'smooth',
                width: 3,
                colors: ['#000000']
            },
            markers: {
                size: 5,
                colors: ['#000000'],
                strokeColors: '#fff',
                strokeWidth: 2
            },
            xaxis: {
                categories: data.line.labels,
                labels: {
                    rotate: -45,
                    rotateAlways: true
                }
            },
            yaxis: {
                title: {
                    text: 'Nombre de mobilités'
                }
            },
            grid: {
                borderColor: '#e0e0e0'
            },
            tooltip: {
                theme: 'light'
            }
        };
        
        lineChart = new ApexCharts(document.querySelector("#chartLine"), lineOptions);
        lineChart.render();
        
    } catch (error) {
        console.error('Erreur chargement données:', error);
    }
}

// Charger les données au chargement de la page
document.addEventListener('DOMContentLoaded', loadChartData);
</script>
{% endblock %}